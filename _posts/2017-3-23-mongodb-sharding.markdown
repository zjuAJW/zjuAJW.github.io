---
layout:     post
title:      "MongoDB分片"
subtitle:   ""
date:       2017-03-23 13:32:00
author:     "AJW"
header-img: "img/mongodb.jpg"
tags:
    - MongoDB
---

MongoDB分片（sharding）是指将数据拆分，分散在不同机器上的过程。它可以使得我们不需要配置强大的服务器就可以存储更多的数据，处理更大的负载。分片是Mongo最复杂的配置方式，这里记录一些分片的知识点和注意问题。

## 分片集群的组件

一个分片集群包含三种组件：

* 分片服务器（shard）
* 路由服务器（mongos）
* 配置服务器（config servers）

### 分片服务器

分片服务器存储了整个分片数据集的一个子集。通常一个分片服务器应该是一个复制集，以来保证数据的冗余。在一个单独的分片上执行查询操作只会返回数据的一个子集，只有连接到路由服务器上，才能对整个集群进行读写操作。

### 配置服务器

配置服务器存储了整个分片集群的元数据和配置信息，包括集群中有哪些分片、分片的是哪些集合、数据块的分布等。同时，配置服务器也存储了用于用户验证的信息，并且管理分布式锁。

从mongo3.4开始，配置服务器必须采用副本集的形式，而且必须使用WireTiger引擎，同时有以下限制：

* 不能有仲裁节点
* 不能有延时节点
* 必须建有索引（也就是说buildIndexes选项必须设置为true）

在配分片集群时，要先设置分片服务器，才能添加路由服务器和分片服务器。

### 路由服务器

路由服务器将读写操作路由到分片上，它提供了应用到分片集群的唯一接口。用户不应该直接连接到分片服务器上。路由服务器通过缓存配置服务器上的元数据来得知各个分片上有哪些数据，而它自身不存储数据。  
通常会把mongos服务器和应用程序运行在同一台服务器上。

所以，mongo的分片是一种自动分片，意思是说，应用层对分片是全然不知的，也不知道数据到底在哪个分片上，用户使用分片集群时和使用单个mongo服务是完全相同的。应用程序只需要连接到路由服务器就可以了，路由服务器会将用户请求路由到相应的分片上去。

![自动分片](/img/in-post/mongo-sharding/auto-sharding.PNG)

## Mongo对集群数据的追踪

mongos通过块（chunk）来追踪文档的位置。每个块由给定片键特定范围内的文档组成。一个块只能存在于一个分片上，所以mongodb用一个比较小的表就能够维护块跟分片的映射。通过查看mongos的config.chunk集合可以查看目前的块信息。

### 块范围

新的分片集群块范围是负无穷到正无穷，它包含了所有的数据，随着数据量的增大，块会自动分成更小的块，每个块的范围是一个左闭右开的区间。

### 拆分块

mongos会记录每个块中插入了多少数据，一旦达到了某个阈值（应该就是chunksize），就会检查是否需要对块进行拆分。如果块确实需要拆分，mongos就会在配置服务器上更新这个块的元信息。注意，块的拆分只需要更改块的元数据即可，**不需要对数据进行移动**。

分片拆分点是由分片自己决定的。当mongos向分片询问是否需要被拆分时，分片会对块大小进行粗略的计算，如果发现块正在不断变大，它就会计算出合适的拆分点，然后将这些信息发送给mongos。当然，分片可能找不到任何可用的拆分点，因为合法拆分块的方法有限。例如，具有相同片键的文档必须保存在相同的块中，如果一个块中的文档片键值都相同，那么该块就无法拆分。

## 均衡器

均衡器（balancer）负责数据的迁移。它会周期性地检查分片间是否存在不均衡，如果存在，则会开始块的迁移。从3.4版本开始，均衡器运行在配置服务器的主节点上。

## 片键

片键决定了各个分片上数据的分布。片键必须是建有索引的，或者是复合索引的前缀键。一旦选定了片键进行分片，则片键和片键的值就都不可变了。

### 片键的索引

如前文所述，片键上必须有索引，或者是单索引，或者片键是复合索引的前缀键。片键上的索引可以是**唯一索引**，但是除了**片键**和**_id**字段，其他字段就不能有唯一索引了。

### 片键的选择

片键的选择直接影响了数据块在分片上的分布，进而影响整个集群的性能。  
通常片键有两种常见的形式：升序片键