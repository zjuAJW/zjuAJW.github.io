---
layout:     post
title:      "MongoDB分片"
subtitle:   ""
date:       2017-03-23 13:32:00
author:     "AJW"
header-img: "img/mongodb.jpg"
tags:
    - MongoDB
---

MongoDB分片（sharding）是指将数据拆分，分散在不同机器上的过程。它可以使得我们不需要配置强大的服务器就可以存储更多的数据，处理更大的负载。分片是Mongo最复杂的配置方式，这里记录一些分片的知识点和注意问题。

## 分片集群的组件

一个分片集群包含三种组件：

* 分片服务器（shard）
* 路由服务器（mongos）
* 配置服务区（config servers）

### 分片服务器

分片服务器存储了整个分片数据集的一个子集。通常一个分片服务器应该是一个复制集，以来保证数据的冗余。在一个单独的分片上执行查询操作只会返回数据的一个子集，只有连接到路由服务器上，才能对整个集群进行读写操作。

### 配置服务器

配置服务器存储了整个分片集群的元数据和配置信息，包括集群中有哪些分片、分片的是哪些集合、数据块的分布等。同时，配置服务器也存储了用于用户验证的信息，并且管理分布式锁。

从mongo3.4开始，配置服务器必须采用副本集的形式，而且必须使用WireTiger引擎，同时有以下限制：

* 不能有仲裁节点
* 不能有延时节点
* 必须建有索引（也就是说buildIndexes选项必须设置为true）

### 路由服务器

路由服务器将读写操作路由到分片上，它提供了应用到分片集群的唯一接口。用户不应该直接连接到分片服务器上。路由服务器通过缓存配置服务器上的元数据来得知各个分片上有哪些数据，而它自身不存储数据。

通常会把mongos服务器和应用程序运行在同一台服务器上。

## 片键

片键决定了各个分片上数据的分布。片键必须是建有索引的，或者是复合索引的前缀键。一旦选定了片键进行分片，则片键和片键的值就都不可变了。

### 片键的索引

如前文所述，片键上必须有索引，或者是单索引，或者片键是复合索引的前缀键。片键上的索引可以是**唯一索引**，但是除了**片键**和**_id**字段，其他字段就不能有唯一索引了。

### 片键的选择

片键的选择直接影响了数据块在分片上的分布，进而影响整个集群的性能。